

function reports(){
	document.getElementById("load").click();
	document.getElementById("spantag").innerHTML="Data Loading  Please Wait....";
	var cmycd=document.getElementById("cmycd").value;
//	var qry="SELECT dm_dpt_nm,ihd_iwd_typ as trftyp,ihd_rcvd_prty as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd=\'"+cmycd+"\' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_iwd_typ,ihd_rcvd_prty union all SELECT dm_dpt_nm,case when aphd_aly_typ='100' then 'Alloy' else (case when aphd_aly_typ='AlloyReceived' then 'Alloy' else aphd_aly_typ end ) end as trftyp,aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_aly_typ,aphd_expt_prty union all SELECT dm_dpt_nm,cphd_cst_typ,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,cphd_cst_typ,crtm_carat_prty union all select dm_dpt_nm as fmdptnm,case when ithd_itm_trn_typ='JOB WORK-DMainReceived' then 'JobCard' else (case when ithd_itm_trn_typ='RecoveryRecieved' then 'Recovery' else (case when ithd_itm_trn_typ='AlloyReceived' then 'Alloy' else (case when ithd_itm_trn_typ='BomStock' then 'BOM' else ithd_itm_trn_typ end) end) end) end as trftyp,ithd_itm_prty as commprty,sum(cast(ithd_itm_iss_wgt as float)) as issuwt,'0' as revwt,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd  inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  [ithd_trf_sts]<>'0' and ithd_frm_dpt_cd <> '10006'  group by dm_dpt_nm,ithd_itm_trn_typ,ithd_itm_prty union all select dm_dpt_nm as todepnm,case when ithd_itm_trn_typ='JOB WORK-DMainReceived' then 'JobCard' else (case when ithd_itm_trn_typ='RecoveryRecieved' then 'Recovery' else (case when ithd_itm_trn_typ='AlloyReceived' then 'Alloy' else (case when ithd_itm_trn_typ='BomStock' then 'BOM' else ithd_itm_trn_typ end) end) end) end as trftyp,ithd_itm_prty as commprty,'0' as issuwt,sum(cast(ithd_itm_iss_wgt as float)) as revwt,'0' as issupg,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1' group by dm_dpt_nm,ithd_itm_trn_typ,ithd_itm_prty union all select dm_dpt_nm,smd_trf_typ,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,smd_trf_typ,smd_mtl_prty union all select dm_dpt_nm,'JobCard' as typ,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,dhd_trf_typ,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_trf_typ,dhd_isd_prty union all SELECT dm_dpt_nm,dhd_trf_typ,dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_trf_typ,dhd_isd_prty order by 1,2,3";
//	var qry="SELECT dm_dpt_nm,'Metal' as process,ihd_rcvd_prty as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd=\'"+cmycd+"\' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_rcvd_prty union all SELECT dm_dpt_nm,'Metal' as process,aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty union all SELECT dm_dpt_nm,'Metal' as process,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,crtm_carat_prty union all select dm_dpt_nm as fmdptnm,'Metal' as process,ithd_itm_prty as commprty,sum(cast(ithd_itm_iss_wgt as float)) as issuwt,'0' as revwt,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd  inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  [ithd_trf_sts]<>'0' and ithd_frm_dpt_cd <> '10006'  group by dm_dpt_nm,ithd_itm_prty union all select dm_dpt_nm as todepnm,'Metal' as process,ithd_itm_prty as commprty,'0' as issuwt,sum(cast(ithd_itm_iss_wgt as float)) as revwt,'0' as issupg,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1' group by dm_dpt_nm,ithd_itm_prty union all SELECT dm_dpt_nm,'Metal' as process,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,smd_mtl_prty union all SELECT dm_dpt_nm,'Metal' as process,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,'Metal' as process,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,'Metal' as process,dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty order by 1,3";
//	var qry="SELECT dm_dpt_nm,'Metal' as process,ihd_rcvd_prty as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd=\'"+cmycd+"\' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_rcvd_prty union all SELECT dm_dpt_nm,'Metal' as process,aphd_mtl_prty as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,'0' as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,'0' as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_mtl_prty  union all SELECT dm_dpt_nm,'Metal' as process,aphd_expt_prty as commprty,'0' as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,'0' as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty union all SELECT dm_dpt_nm,'Metal' as process,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,crtm_carat_prty union all select dm_dpt_nm as fmdptnm,'Metal' as process,ithd_itm_prty as commprty,sum(cast(ithd_itm_iss_wgt as float)) as issuwt,'0' as revwt,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd  inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  [ithd_trf_sts]<>'0' and ithd_frm_dpt_cd <> '10006'  group by dm_dpt_nm,ithd_itm_prty union all select dm_dpt_nm as todepnm,'Metal' as process,ithd_itm_prty as commprty,'0' as issuwt,sum(cast(ithd_itm_iss_wgt as float)) as revwt,'0' as issupg,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1' group by dm_dpt_nm,ithd_itm_prty union all SELECT dm_dpt_nm,'Metal' as process,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,smd_mtl_prty union all SELECT dm_dpt_nm,'Metal' as process,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,'Metal' as process,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,'Metal' as process,dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty order by 1,3 ";
	
	//var qry="SELECT dm_dpt_nm,'Metal' as process,cast(ihd_rcvd_prty as decimal(5,2)) as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd=\'"+cmycd+"\' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_rcvd_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(aphd_mtl_prty as decimal(5,2)) as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,'0' as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,'0' as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_mtl_prty  union all SELECT dm_dpt_nm,'Metal' as process,cast(aphd_expt_prty as decimal(5,2)) as commprty,'0' as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,'0' as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(crtm_carat_prty as decimal(5,2)) as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,crtm_carat_prty union all select dm_dpt_nm as fmdptnm,'Metal' as process,cast(ithd_itm_prty as decimal(5,2)) as commprty,sum(cast(ithd_itm_iss_wgt as float)) as issuwt,'0' as revwt,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd  inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  [ithd_trf_sts]<>'0' and ithd_frm_dpt_cd <> '10006'  group by dm_dpt_nm,ithd_itm_prty union all select dm_dpt_nm as todepnm,'Metal' as process,cast(ithd_itm_prty as decimal(5,2)) as commprty,'0' as issuwt,sum(cast(ithd_itm_iss_wgt as float)) as revwt,'0' as issupg,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1' group by dm_dpt_nm,ithd_itm_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(smd_mtl_prty as decimal(5,2)) as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,smd_mtl_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(sphd_iss_stk_prty as decimal(5,2)) as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(dhd_isd_prty as decimal(5,2)) as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(dhd_isd_prty as decimal(5,2)) as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty order by 1,3 ";
//	var qry="SELECT dm_dpt_nm,'Metal' as process,cast(case when ihd_rcvd_prty<>''then ihd_rcvd_prty else '0' end as decimal(5,2)) as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd='10001' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_rcvd_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(aphd_mtl_prty as decimal(5,2)) as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,'0' as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,'0' as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' group by dm_dpt_nm,aphd_mtl_prty  union all SELECT dm_dpt_nm,'Metal' as process,cast(case when aphd_expt_prty<>'' then aphd_expt_prty else '0'end  as decimal(5,2)) as commprty,'0' as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,'0' as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' group by dm_dpt_nm,aphd_expt_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(case when crtm_carat_prty<>'' then crtm_carat_prty else '0' end as decimal(5,2)) as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd='10001') where cphd_cmy_cd='10001' group by dm_dpt_nm,crtm_carat_prty union all select dm_dpt_nm as fmdptnm,'Metal' as process,cast(case when ithd_itm_prty<>'' then ithd_itm_prty else '0' end as decimal(5,2)) as commprty,sum(cast(ithd_itm_iss_wgt as float)) as issuwt,'0' as revwt,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd  inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd='10001' and  [ithd_trf_sts]<>'0' and ithd_frm_dpt_cd <> '10006'  group by dm_dpt_nm,ithd_itm_prty union all select dm_dpt_nm as todepnm,'Metal' as process,cast(case when ithd_itm_prty<>'' then ithd_itm_prty else '0' end  as decimal(5,2)) as commprty,'0' as issuwt,sum(cast(ithd_itm_iss_wgt as float)) as revwt,'0' as issupg,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd='10001' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1' group by dm_dpt_nm,ithd_itm_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(case when smd_mtl_prty<>'' then  smd_mtl_prty else '0' end  as decimal(5,2)) as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd='10001' group by dm_dpt_nm,smd_mtl_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(case when sphd_iss_stk_prty<>'' then  sphd_iss_stk_prty else '0' end as decimal(5,2)) as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd='10001' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(case when dhd_isd_prty<>'' then dhd_isd_prty else '0' end  as decimal(5,2)) as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(case when dhd_isd_prty<>'' then dhd_isd_prty else '0' end  as decimal(5,2)) as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty order by 1,3";
	var qry="SELECT dm_dpt_nm,'Metal' as process,cast(case when ihd_rcvd_prty<>''then ihd_rcvd_prty else '0' end as decimal(5,2)) as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd=\'"+cmycd+"\' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_rcvd_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(aphd_mtl_prty as decimal(5,2)) as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,'0' as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,'0' as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_mtl_prty  union all SELECT dm_dpt_nm,'Metal' as process,cast(case when aphd_expt_prty<>'' then aphd_expt_prty else '0'end  as decimal(5,2)) as commprty,'0' as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,'0' as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(case when crtm_carat_prty<>'' then crtm_carat_prty else '0' end as decimal(5,2)) as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,crtm_carat_prty union all select dm_dpt_nm as fmdptnm,'Metal' as process,cast(case when ithd_itm_prty<>'' then ithd_itm_prty else '0' end as decimal(5,2)) as commprty,case when ithd_itm_trn_typ<>'Bom' then sum(cast(ithd_itm_iss_wgt as float)) else (select top 1 ith_tot_iss_wgt from intl_trf_hdr where ith_doc_no=ithd_doc_no) end as issuwt,'0' as revwt,case when ithd_itm_trn_typ<>'Bom' then round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3)else round(((select top 1 cast(ith_tot_iss_wgt as float) from intl_trf_hdr where ith_doc_no=ithd_doc_no)*(cast(case when ithd_itm_prty<>'' then ithd_itm_prty else '0' end as decimal(5,2))))/100,3) end as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd  inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  [ithd_trf_sts]<>'0' and ithd_frm_dpt_cd <> '10006'  group by ithd_doc_no,ithd_itm_trn_typ,dm_dpt_nm,ithd_itm_prty union all select dm_dpt_nm as todepnm,'Metal' as process,cast(case when ithd_itm_prty<>'' then ithd_itm_prty else '0' end  as decimal(5,2)) as commprty,'0' as issuwt,case when ithd_itm_trn_typ<>'Bom' then sum(cast(ithd_itm_iss_wgt as float)) else (select top 1 ith_tot_iss_wgt from intl_trf_hdr where ith_doc_no=ithd_doc_no) end as revwt,'0' as issupg,case when ithd_itm_trn_typ<>'Bom' then round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) else round(((select top 1 cast(ith_tot_iss_wgt as float) from intl_trf_hdr where ith_doc_no=ithd_doc_no)*(cast(case when ithd_itm_prty<>'' then ithd_itm_prty else '0' end as decimal(5,2))))/100,3) end as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1'  group by ithd_doc_no,ithd_itm_trn_typ,dm_dpt_nm,ithd_itm_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(case when smd_mtl_prty<>'' then  smd_mtl_prty else '0' end  as decimal(5,2)) as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,smd_mtl_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(case when sphd_iss_stk_prty<>'' then  sphd_iss_stk_prty else '0' end as decimal(5,2)) as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(case when dhd_isd_prty<>'' then dhd_isd_prty else '0' end  as decimal(5,2)) as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,'Metal' as process,cast(case when dhd_isd_prty<>'' then dhd_isd_prty else '0' end  as decimal(5,2)) as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty order by 1,3";

	AjaxController.getInwardReport(cmycd,qry,inwardRecords);
}
function inwardRecords(result){
	var dept='',type='',purity='';
	var issuwt=0,rcvwt=0,issupg=0,recpg=0;
	var res="";
	var issuetotal=0,receivetotal=0,issuepgtot=0,receivepgtot=0;
	if(result!=null && result.length>0){
		var count=0;
		if(result.length>1){
			for (var i = 0; i < result.length; i++) {
				if(i==0){
					dept=result[i][0];
					type=result[i][1];
					purity=result[i][2];
					issuwt=Number(result[i][3]);
					rcvwt=Number(result[i][4]);
					issupg=Number(result[i][5]);
					recpg=Number(result[i][6]);
					if(typeof(result[i+1]) != "undefined" && dept==result[i+1][0] && type==result[i+1][1] && purity==result[i+1][2]){}
					else{
						if(Number(Number(rcvwt)-Number(issuwt)).toFixed(3)!=0.000 || Number(Number(recpg)-Number(issupg)).toFixed(3)!=0.000){
						res+='<tr>'
							+'<td class=""><label class="control-label lbl" >'+(++count)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][0]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][1]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][2]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(Number(rcvwt)-Number(issuwt)).toFixed(3)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(Number(recpg)-Number(issupg)).toFixed(3)+'</label></td>'
							+'</tr>';
						}
						issuetotal+=issuwt;
						receivetotal+=rcvwt;
						issuepgtot+=issupg;
						receivepgtot+=recpg;
						issuwt=0,rcvwt=0,issupg=0,recpg=0;
						dept=result[i+1][0];
						type=result[i+1][1];
						purity=result[i+1][2];
					}
					
				}else{
					if(typeof(result[i+1])!='undefined' && dept==result[i+1][0] && type==result[i+1][1] && purity==result[i+1][2]){
						issuwt+=Number(result[i][3]);
						rcvwt+=Number(result[i][4]);
						issupg+=Number(result[i][5]);
						recpg+=Number(result[i][6]);
					}else{
						issuwt+=Number(result[i][3]);
						rcvwt+=Number(result[i][4]);
						issupg+=Number(result[i][5]);
						recpg+=Number(result[i][6]);
						if(Number(Number(rcvwt)-Number(issuwt)).toFixed(3)!=0.000 || Number(Number(recpg)-Number(issupg)).toFixed(3)!=0.000){
							res+='<tr>'
								+'<td class=""><label class="control-label lbl" >'+(++count)+'</label></td>'
								+'<td class=""><label class="control-label lbl" >'+result[i][0]+'</label></td>'
								+'<td class=""><label class="control-label lbl" >'+result[i][1]+'</label></td>'
								+'<td class=""><label class="control-label lbl" >'+result[i][2]+'</label></td>'
								+'<td class=""><label class="control-label lbl" >'+Number(Number(rcvwt)-Number(issuwt)).toFixed(3)+'</label></td>'
								+'<td class=""><label class="control-label lbl" >'+Number(Number(recpg)-Number(issupg)).toFixed(3)+'</label></td>'
								+'</tr>';
						}
						issuetotal+=issuwt;
						receivetotal+=rcvwt;
						issuepgtot+=issupg;
						receivepgtot+=recpg;
						issuwt=0,rcvwt=0,issupg=0,recpg=0;
						if(typeof(result[i+1])!='undefined') dept=result[i+1][0];
						if(typeof(result[i+1])!='undefined') type=result[i+1][1];
						if(typeof(result[i+1])!='undefined') purity=result[i+1][2];
					}
				}
			}
		}
		else{
			res+='<tr>'
				+'<td class=""><label class="control-label lbl" >'+(++count)+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[0][0]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[0][1]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[0][2]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(Number(result[0][4])-Number(result[0][3])).toFixed(3)+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(Number(result[0][6])-Number(result[0][5])).toFixed(3)+'</label></td>'
				+'</tr>';
			issuetotal+=Number(result[0][3]);;
			receivetotal+=Number(result[0][4]);;
			issuepgtot+=Number(result[0][5]);;
			receivepgtot+=Number(result[0][6]);;
		}
	}
	if(result.length>0){
		res+='<tr>'
			+'<td class=""><label class="control-label lbl" >Total</label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" >'+Number(Number(receivetotal)-Number(issuetotal)).toFixed(3)+'</label></td>'
			+'<td class=""><label class="control-label lbl" >'+Number(Number(receivepgtot)-Number(issuepgtot)).toFixed(3)+'</label></td>'
			+'</tr>';
	}
	document.getElementById("allrecords").innerHTML=res;
	$('#myModal').modal('hide');
}
function getWorkerWiseReport(){
	var cmycd=document.getElementById("cmycd").value;
//	var qry="SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Alloying' as stocktyp,'Alloying' as process,aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)+cast(aphd_iss_aly as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' inner join emp_mst on (em_cmy_cd=aphd_cmy_cd and em_emp_id=aphd_wrk_cd) group by dm_dpt_nm,em_emp_nm,aphd_expt_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Casting' as stocktyp,'Casting' as process ,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') inner join emp_mst on (em_cmy_cd=cphd_cmy_cd and em_emp_id=cphd_wrk_cd)  where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,em_emp_nm,crtm_carat_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,smd_wrk_typ as wrktyp,'Melting' as stocktyp,'Melting' as process,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=smd_cmy_cd and vcm_vnct_cd=smd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=smd_cmy_cd and em_emp_id=smd_wrk_cd) where smd_cmy_cd=\'"+cmycd+"\'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),smd_wrk_typ,smd_mtl_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,sphd_wrk_typ as wrktyp,'Sub-Process' as stocktyp,'Sub-Process' as process,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=sphd_cmy_cd and vcm_vnct_cd=sphd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=sphd_cmy_cd and em_emp_id=sphd_wrk_cd) where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),sphd_wrk_typ,sphd_iss_stk_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd) where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd)  where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Metal' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,-sum(cast(rhd_rcvy as float)) as issuwt,-sum(cast(rhd_rcvy_mtl as float)) as rcvwt,-sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Recovery' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,sum(cast(rhd_rcvy as float)) as issuwt,sum(cast(rhd_rcvy_mtl as float)) as rcvwt,sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty order by 1,2,3,4,6";
	var qry="SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Alloying' as stocktyp,'Alloying' as process,aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)+cast(aphd_iss_aly as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' inner join emp_mst on (em_cmy_cd=aphd_cmy_cd and em_emp_id=aphd_wrk_cd) group by dm_dpt_nm,em_emp_nm,aphd_expt_prty  union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Casting' as stocktyp,'Casting' as process ,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd='10001') inner join emp_mst on (em_cmy_cd=cphd_cmy_cd and em_emp_id=cphd_wrk_cd)  where cphd_cmy_cd='10001' group by dm_dpt_nm,em_emp_nm,crtm_carat_prty  union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,smd_wrk_typ as wrktyp,'Melting' as stocktyp,'Melting' as process,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=smd_cmy_cd and vcm_vnct_cd=smd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=smd_cmy_cd and em_emp_id=smd_wrk_cd) where smd_cmy_cd='10001'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),smd_wrk_typ,smd_mtl_prty  union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,sphd_wrk_typ as wrktyp,'Sub-Process' as stocktyp,'Sub-Process' as process,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=sphd_cmy_cd and vcm_vnct_cd=sphd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=sphd_cmy_cd and em_emp_id=sphd_wrk_cd) where sphd_cmy_cd='10001' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),sphd_wrk_typ,sphd_iss_stk_prty  union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd) where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty  union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,case when dhd_trf_typ='Recovery' then (select top 1 cast(rhd_rqd_prty as float) from rcvy_hdr_dtl where rhd_cmy_cd='10001' and dhd_isd_itm_cd=rhd_doc_no) else  dhd_isd_prty end as commprty,(cast('0' as float))as isswt,case when dhd_trf_typ='Recovery' then round(cast(dhd_rcvd_wgt as float)*cast(dhd_isd_prty as float)/(select top 1 cast(rhd_rqd_prty as float) from rcvy_hdr_dtl where rhd_cmy_cd='10001' and dhd_isd_itm_cd=rhd_doc_no),3) else (cast(dhd_rcvd_wgt as float)) end as recwt,'0' as isspg,round(((cast(dhd_isd_prty as float)*cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd)  where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess'  union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Metal' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,-sum(cast(rhd_rcvy as float)) as issuwt,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/cast(rhd_rqd_prty as float),3)) as rcvwt,-sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd='10001'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty  union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Recovery' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,sum(cast(rhd_rcvy as float)) as issuwt,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/cast(rhd_rqd_prty as float),3)) as rcvwt,sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd='10001'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty order by 1,2,3,4,6";
	AjaxController.getWorkerWiseReport(cmycd,qry,workerrecords);
}
function workerrecords(result){
	var res="";
	var count=0;
	if(result!=null && result.length>0){
		var dept='',emp='',wrktyp='',process='',purity='';
		var isuwt=0,rcvwt=0,isupg=0,rcvpg=0;
		var issuetotal=0,receivetotal=0,issuepgtot=0,receivepgtot=0;
		if(result.length>1){
			for (var i = 0; i < result.length; i++) {
				if(i==0){
					dept=result[i][0];
					emp=result[i][1];
					wrktyp=result[i][2];
					process=result[i][3];
					purity=result[i][5];
					isuwt=result[i][6];
					rcvwt=result[i][7];
					isupg=result[i][8];
					rcvpg=result[i][9];
					if(typeof(result[i+1])!='undefined' && dept==result[i+1][0] && emp==result[i+1][1] && wrktyp==result[i+1][2] && process==result[i+1][3] && purity==result[i+1][5]){}
					else{
						if(Number(Number(isuwt)-Number(rcvwt)).toFixed(3)!=0.000 || Number(Number(isupg)-Number(rcvpg)).toFixed(3)!=0.000){
						res+='<tr>'
							+'<td class=""><label class="control-label lbl" >'+(++count)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][0]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][1]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][2]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][3]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][5]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(Number(isuwt)-Number(rcvwt)).toFixed(3)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(Number(isupg)-Number(rcvpg)).toFixed(3)+'</label></td>'
							+'</tr>';
						}
						issuetotal+=isuwt;
						receivetotal+=rcvwt;
						issuepgtot+=isupg;
						receivepgtot+=rcvpg;
						isuwt=0,rcvwt=0,isupg=0,rcvpg=0;
						if(typeof(result[i+1])!='undefined')dept=result[i+1][0];
						if(typeof(result[i+1])!='undefined')emp=result[i+1][1];
						if(typeof(result[i+1])!='undefined')wrktyp=result[i+1][2];
						if(typeof(result[i+1])!='undefined')process=result[i+1][3];
						if(typeof(result[i+1])!='undefined')purity=result[i+1][5];
					}
				}else{
					if(typeof(result[i+1])!='undefined' && dept==result[i+1][0] && emp==result[i+1][1] && wrktyp==result[i+1][2] && process==result[i+1][3] && purity==result[i+1][5]){
						isuwt+=Number(result[i][6]);
						rcvwt+=Number(result[i][7]);
						isupg+=Number(result[i][8]);
						rcvpg+=Number(result[i][9]);
						
					}else{
						isuwt+=Number(result[i][6]);
						rcvwt+=Number(result[i][7]);
						isupg+=Number(result[i][8]);
						rcvpg+=Number(result[i][9]);
						if(Number(Number(isuwt)-Number(rcvwt)).toFixed(3)!=0.000 || Number(Number(isupg)-Number(rcvpg)).toFixed(3)!=0.000){
						res+='<tr>'
							+'<td class=""><label class="control-label lbl" >'+(++count)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][0]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][1]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][2]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][3]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][5]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(Number(isuwt)-Number(rcvwt)).toFixed(3)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(Number(isupg)-Number(rcvpg)).toFixed(3)+'</label></td>'
							+'</tr>';
					}
						issuetotal+=isuwt;
						receivetotal+=rcvwt;
						issuepgtot+=isupg;
						receivepgtot+=rcvpg;
						isuwt=0,rcvwt=0,isupg=0,rcvpg=0;
						if(typeof(result[i+1])!='undefined')dept=result[i+1][0];
						if(typeof(result[i+1])!='undefined')emp=result[i+1][1];
						if(typeof(result[i+1])!='undefined')wrktyp=result[i+1][2];
						if(typeof(result[i+1])!='undefined')process=result[i+1][3];
						if(typeof(result[i+1])!='undefined')purity=result[i+1][5];
					}
				}
				
			}
		
		}else{
			if(Number(Number(result[0][6])-Number(result[0][7])).toFixed(3)!=0.000 || Number(Number(result[0][8])-Number(result[0][9])).toFixed(3)!=0.000){
			res+='<tr>'
				+'<td class=""><label class="control-label lbl" >1</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[0][0]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[0][1]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[0][2]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[0][3]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(result[0][5]).toFixed(3)+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(Number(result[0][6])-Number(result[0][7])).toFixed(3)+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(Number(result[0][8])-Number(result[0][9])).toFixed(3)+'</label></td>'
				+'</tr>';
			}
			issuetotal+=Number(result[0][6]);;
			receivetotal+=Number(result[0][7]);;
			issuepgtot+=Number(result[0][8]);;
			receivepgtot+=Number(result[0][9]);;
		}
		
		res+='<tr>'
			+'<td class=""><label class="control-label lbl" >Total</label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" >'+Number(Number(issuetotal)-Number(receivetotal)).toFixed(3)+'</label></td>'
			+'<td class=""><label class="control-label lbl" >'+Number(Number(issuepgtot)-Number(receivepgtot)).toFixed(3)+'</label></td>'
			+'</tr>';
	}
	
	document.getElementById("workerrecords").innerHTML=res;
}
function getWorkerWiseReportOutSideWorker(){
	var cmycd=document.getElementById("cmycd").value;
//	var qry="SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Alloying' as stocktyp,'Alloying' as process,aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)+cast(aphd_iss_aly as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' inner join emp_mst on (em_cmy_cd=aphd_cmy_cd and em_emp_id=aphd_wrk_cd) group by dm_dpt_nm,em_emp_nm,aphd_expt_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Casting' as stocktyp,'Casting' as process ,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') inner join emp_mst on (em_cmy_cd=cphd_cmy_cd and em_emp_id=cphd_wrk_cd)  where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,em_emp_nm,crtm_carat_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,smd_wrk_typ as wrktyp,'Melting' as stocktyp,'Melting' as process,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=smd_cmy_cd and vcm_vnct_cd=smd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=smd_cmy_cd and em_emp_id=smd_wrk_cd) where smd_cmy_cd=\'"+cmycd+"\'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),smd_wrk_typ,smd_mtl_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,sphd_wrk_typ as wrktyp,'Sub-Process' as stocktyp,'Sub-Process' as process,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=sphd_cmy_cd and vcm_vnct_cd=sphd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=sphd_cmy_cd and em_emp_id=sphd_wrk_cd) where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),sphd_wrk_typ,sphd_iss_stk_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd) where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd)  where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Metal' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,-sum(cast(rhd_rcvy as float)) as issuwt,-sum(cast(rhd_rcvy_mtl as float)) as rcvwt,-sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Recovery' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,sum(cast(rhd_rcvy as float)) as issuwt,sum(cast(rhd_rcvy_mtl as float)) as rcvwt,sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty order by 1,2,3,4,6";
	
	//var qry="SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Alloying' as stocktyp,'Alloying' as process,cast(aphd_expt_prty as decimal(5,2)) as commprty,sum(cast(aphd_iss_wgt as float)+cast(aphd_iss_aly as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' inner join emp_mst on (em_cmy_cd=aphd_cmy_cd and em_emp_id=aphd_wrk_cd) group by dm_dpt_nm,em_emp_nm,aphd_expt_prty  union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Casting' as stocktyp,'Casting' as process ,cast(crtm_carat_prty as decimal(5,2)) as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd='10001') inner join emp_mst on (em_cmy_cd=cphd_cmy_cd and em_emp_id=cphd_wrk_cd)  where cphd_cmy_cd='10001' group by dm_dpt_nm,em_emp_nm,crtm_carat_prty  union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,smd_wrk_typ as wrktyp,'Melting' as stocktyp,'Melting' as process,cast(smd_mtl_prty as decimal(5,2)) as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=smd_cmy_cd and vcm_vnct_cd=smd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=smd_cmy_cd and em_emp_id=smd_wrk_cd) where smd_cmy_cd='10001'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),smd_wrk_typ,smd_mtl_prty  union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,sphd_wrk_typ as wrktyp,'Sub-Process' as stocktyp,'Sub-Process' as process,cast(sphd_iss_stk_prty as decimal(5,2)) as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=sphd_cmy_cd and vcm_vnct_cd=sphd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=sphd_cmy_cd and em_emp_id=sphd_wrk_cd) where sphd_cmy_cd='10001' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),sphd_wrk_typ,sphd_iss_stk_prty  union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,cast(dhd_isd_prty as decimal(5,2)) as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd) where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty  union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,case when dhd_trf_typ='Recovery' then (select top 1 cast(rhd_rqd_prty as decimal(5,2)) from rcvy_hdr_dtl where rhd_cmy_cd='10001' and dhd_isd_itm_cd=rhd_doc_no) else  cast(dhd_isd_prty as decimal(5,2)) end as commprty,(cast('0' as float))as isswt,case when dhd_trf_typ='Recovery' then round(cast(dhd_rcvd_wgt as float)*cast(dhd_isd_prty as float)/(select top 1 cast(rhd_rqd_prty as float) from rcvy_hdr_dtl where rhd_cmy_cd='10001' and dhd_isd_itm_cd=rhd_doc_no),3) else (cast(dhd_rcvd_wgt as float)) end as recwt,'0' as isspg,round(((cast(dhd_isd_prty as float)*cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd)  where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess'  union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Metal' as stocktyp,'recory' as process,cast(rhd_rqd_prty as decimal(5,2)) as commprty,-sum(cast(rhd_rcvy as float)) as issuwt,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/cast(rhd_rqd_prty as float),3)) as rcvwt,-sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd='10001'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty  union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Recovery' as stocktyp,'recory' as process,cast(rhd_rqd_prty as decimal(5,2)) as commprty,sum(cast(rhd_rcvy as float)) as issuwt,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/cast(rhd_rqd_prty as float),3)) as rcvwt,sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd='10001'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty order by 1,2,3,4,6";
	var qry="SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Alloying' as stocktyp,'Alloying' as process,cast(case when aphd_expt_prty<>'' then aphd_expt_prty else '0' end  as decimal(5,2)) as commprty,sum(cast(aphd_iss_wgt as float)+cast(aphd_iss_aly as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3))as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' inner join emp_mst on (em_cmy_cd=aphd_cmy_cd and em_emp_id=aphd_wrk_cd) group by dm_dpt_nm,em_emp_nm,aphd_expt_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Casting' as stocktyp,'Casting' as process ,cast(crtm_carat_prty as decimal(5,2)) as commprty,sum(cast(cphd_iss_wgt as float))as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd='10001') inner join emp_mst on (em_cmy_cd=cphd_cmy_cd and em_emp_id=cphd_wrk_cd)  where cphd_cmy_cd='10001' group by dm_dpt_nm,em_emp_nm,crtm_carat_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,smd_wrk_typ as wrktyp,'Melting' as stocktyp,'Melting' as process,cast(smd_mtl_prty as decimal(5,2)) as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=smd_cmy_cd and vcm_vnct_cd=smd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=smd_cmy_cd and em_emp_id=smd_wrk_cd) where smd_cmy_cd='10001'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),smd_wrk_typ,smd_mtl_prty  union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,sphd_wrk_typ as wrktyp,'Sub-Process' as stocktyp,'Sub-Process' as process,cast(sphd_iss_stk_prty as decimal(5,2)) as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=sphd_cmy_cd and vcm_vnct_cd=sphd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=sphd_cmy_cd and em_emp_id=sphd_wrk_cd) where sphd_cmy_cd='10001' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),sphd_wrk_typ,sphd_iss_stk_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,cast(case when dhd_isd_prty<>'' then dhd_isd_prty else '0' end  as decimal(5,2)) as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt, round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd) where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm)as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,case when dhd_trf_typ='Recovery' then (select top 1 cast(case when rhd_rqd_prty<>'' then rhd_rqd_prty else'0'  end  as decimal(5,2)) from rcvy_hdr_dtl where rhd_cmy_cd='10001' and dhd_isd_itm_cd=rhd_doc_no) else cast(case when dhd_isd_prty<>''  then dhd_isd_prty else '0' end as decimal(5,2)) end as commprty,(cast('0' as float))as isswt,case when dhd_trf_typ='Recovery' then  round(cast(dhd_rcvd_wgt as float)*cast(dhd_isd_prty as float)/(select top 1 cast(rhd_rqd_prty as float) from rcvy_hdr_dtl  where rhd_cmy_cd='10001' and dhd_isd_itm_cd=rhd_doc_no),3) else (cast(dhd_rcvd_wgt as float)) end as recwt,'0' as isspg,round(((cast(dhd_isd_prty as float)*cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd)  where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess'union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Metal' as stocktyp,'recory' as process,cast(rhd_rqd_prty as decimal(5,2)) as commprty,-sum(cast(rhd_rcvy as float)) as issuwt,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/cast(rhd_rqd_prty as float),3)) as rcvwt,-sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd='10001' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Recovery' as stocktyp,'recory' as process,cast(rhd_rqd_prty as decimal(5,2)) as commprty,sum(cast(rhd_rcvy as float))as issuwt,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/cast(rhd_rqd_prty as float),3)) as rcvwt,sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd='10001'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty order by 1,2,3,4,6";

	 
	AjaxController.getWorkerWiseReportOutSideWorker(cmycd,qry,outsideworkerrecords);
}
function outsideworkerrecords(result){
	var res="";
	var count=0;
	if(result!=null && result.length>0){
		var dept='',emp='',wrktyp='',process='',purity='';
		var isuwt=0,rcvwt=0,isupg=0,rcvpg=0;
		var issuetotal=0,receivetotal=0,issuepgtot=0,receivepgtot=0;
		if(result.length>1){
			for (var i = 0; i < result.length; i++) {
				if(i==0){
					dept=result[i][0];
					emp=result[i][1];
					wrktyp=result[i][2];
					process=result[i][3];
					purity=result[i][5];
					isuwt=result[i][6];
					rcvwt=result[i][7];
					isupg=result[i][8];
					rcvpg=result[i][9];
					if(typeof(result[i+1]) != "undefined" &&  dept==result[i+1][0] && emp==result[i+1][1] && wrktyp==result[i+1][2] && process==result[i+1][3] && purity==result[i+1][5]){}
					else{
						if(Number(Number(isuwt)-Number(rcvwt)).toFixed(3)!=0.000 || Number(Number(isupg)-Number(rcvpg)).toFixed(3)!=0.000){
						res+='<tr>'
							+'<td class=""><label class="control-label lbl" >'+(++count)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][0]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][1]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][2]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][3]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][5]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(Number(isuwt)-Number(rcvwt)).toFixed(3)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(Number(isupg)-Number(rcvpg)).toFixed(3)+'</label></td>'
							+'</tr>';
						}
						issuetotal+=isuwt;
						receivetotal+=rcvwt;
						issuepgtot+=isupg;
						receivepgtot+=rcvpg;
						isuwt=0,rcvwt=0,isupg=0,rcvpg=0;
						if(typeof(result[i+1]) != "undefined")dept=result[i+1][0];
						if(typeof(result[i+1]) != "undefined")emp=result[i+1][1];
						if(typeof(result[i+1]) != "undefined")wrktyp=result[i+1][2];
						if(typeof(result[i+1]) != "undefined")process=result[i+1][3];
						if(typeof(result[i+1]) != "undefined")purity=result[i+1][5];
					}
				}else{
					if(typeof(result[i+1]) != "undefined" &&  dept==result[i+1][0] && emp==result[i+1][1] && wrktyp==result[i+1][2] && process==result[i+1][3] && purity==result[i+1][5]){
						isuwt+=Number(result[i][6]);
						rcvwt+=Number(result[i][7]);
						isupg+=Number(result[i][8]);
						rcvpg+=Number(result[i][9]);
						
					}else{
						isuwt+=Number(result[i][6]);
						rcvwt+=Number(result[i][7]);
						isupg+=Number(result[i][8]);
						rcvpg+=Number(result[i][9]);
						if(Number(Number(isuwt)-Number(rcvwt)).toFixed(3)!=0.000 || Number(Number(isupg)-Number(rcvpg)).toFixed(3)!=0.000){
						res+='<tr>'
							+'<td class=""><label class="control-label lbl" >'+(++count)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][0]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][1]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][2]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][3]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][5]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(Number(isuwt)-Number(rcvwt)).toFixed(3)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(Number(isupg)-Number(rcvpg)).toFixed(3)+'</label></td>'
							+'</tr>';
						}
						issuetotal+=isuwt;
						receivetotal+=rcvwt;
						issuepgtot+=isupg;
						receivepgtot+=rcvpg;
						isuwt=0,rcvwt=0,isupg=0,rcvpg=0;
						if(typeof(result[i+1]) != "undefined")dept=result[i+1][0];
						if(typeof(result[i+1]) != "undefined")emp=result[i+1][1];
						if(typeof(result[i+1]) != "undefined")wrktyp=result[i+1][2];
						if(typeof(result[i+1]) != "undefined")process=result[i+1][3];
						if(typeof(result[i+1]) != "undefined")purity=result[i+1][5];
					}
				
					
				}
				
			}
		
		}else{
			if(Number(Number(result[0][6])-Number(result[0][7])).toFixed(3)!=0.000 || Number(Number(result[0][8])-Number(result[0][9])).toFixed(3)!=0.000){
			res+='<tr>'
				+'<td class=""><label class="control-label lbl" >1</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[0][0]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[0][1]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[0][2]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[0][3]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(result[0][5]).toFixed(3)+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(Number(result[0][6])-Number(result[0][7])).toFixed(3)+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(Number(result[0][8])-Number(result[0][9])).toFixed(3)+'</label></td>'
				+'</tr>';
			}
			issuetotal+=Number(result[0][6]);;
			receivetotal+=Number(result[0][7]);;
			issuepgtot+=Number(result[0][8]);;
			receivepgtot+=Number(result[0][9]);;
		}
		res+='<tr>'
			+'<td class=""><label class="control-label lbl" >Total</label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" >'+Number(Number(issuetotal)-Number(receivetotal)).toFixed(3)+'</label></td>'
			+'<td class=""><label class="control-label lbl" >'+Number(Number(issuepgtot)-Number(receivepgtot)).toFixed(3)+'</label></td>'
			+'</tr>';
	}
	
	document.getElementById("outsideworkerrecords").innerHTML=res;
}
function getRecoryReport(){
	var cmycd=document.getElementById("cmycd").value;
	var qry="select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,rhd_rqd_prty as commprty,'recory' as process,sum(cast(rhd_rcvy as float)) as issuwt,sum((cast(rhd_rcvy_mtl as float)*cast(rhd_mtl_prty as float))/cast(rhd_rqd_prty as float)) as rcvwt,sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join vn_ct_mst on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=rhd_cmy_cd and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty";
	AjaxController.getRecoryReport(workertyp,dept,wrkr,outsideworkerrecords);
}
function getPurityLoss(){
	var cmycd=document.getElementById("cmycd").value;
	var qry="select dm_dpt_nm,aphd_expt_prty,sum(cast(aphd_prty_ls as float)) as prtyloss,sum(cast(aphd_expt_prty as float)*cast(aphd_prty_ls as float)/100) as balpg from aly_prcs_hdr_dtl inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty";
	AjaxController.getPurityLossDeptWise(qry,purityLossRecords);
}
function purityLossRecords(result){
	var res="";
	if(result!=null &&  result.length>0){
		var totpg=0;
		var prtyloss=0;
		for(var i=0;i<result.length;i++){
			totpg+=Number(result[i][3]);
			prtyloss+=Number(result[i][2]);
			res+='<tr>'
				+'<td class=""><label class="control-label lbl" >'+(i+1)+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[i][0]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(result[i][1]).toFixed(3)+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(result[i][2]).toFixed(3)+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(result[i][3]).toFixed(3)+'</label></td>'
				+'</tr>';
		}
		res+='<tr>'
			+'<td class=""><label class="control-label lbl" >Total</label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" >'+Number(prtyloss).toFixed(3)+'</label></td>'
			+'<td class=""><label class="control-label lbl" >'+Number(totpg).toFixed(3)+'</label></td>'
			+'</tr>';
		
	}
	document.getElementById("purityloss").innerHTML=res;
}
function getClosingStockReports(){
	var cmycd=document.getElementById("cmycd").value;
//	var qry="SELECT dm_dpt_nm,'','','Metal' as process,'',ihd_rcvd_prty as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd=\'"+cmycd+"\' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_rcvd_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,crtm_carat_prty union all select dm_dpt_nm as fmdptnm,'','','Metal' as process,'',ithd_itm_prty as commprty,sum(cast(ithd_itm_iss_wgt as float)) as issuwt,'0' as revwt,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd  inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  [ithd_trf_sts]<>'0' and ithd_frm_dpt_cd <> '10006'  group by dm_dpt_nm,ithd_itm_prty union all select dm_dpt_nm as todepnm,'','','Metal' as process,'',ithd_itm_prty as commprty,'0' as issuwt,sum(cast(ithd_itm_iss_wgt as float)) as revwt,'0' as issupg,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1' group by dm_dpt_nm,ithd_itm_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,smd_mtl_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Alloying' as stocktyp,'Alloying' as process,aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)+cast(aphd_iss_aly as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' inner join emp_mst on (em_cmy_cd=aphd_cmy_cd and em_emp_id=aphd_wrk_cd) group by dm_dpt_nm,em_emp_nm,aphd_expt_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Casting' as stocktyp,'Casting' as process ,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') inner join emp_mst on (em_cmy_cd=cphd_cmy_cd and em_emp_id=cphd_wrk_cd)  where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,em_emp_nm,crtm_carat_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,smd_wrk_typ as wrktyp,'Melting' as stocktyp,'Melting' as process,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=smd_cmy_cd and vcm_vnct_cd=smd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=smd_cmy_cd and em_emp_id=smd_wrk_cd) where smd_cmy_cd=\'"+cmycd+"\'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),smd_wrk_typ,smd_mtl_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,sphd_wrk_typ as wrktyp,'Sub-Process' as stocktyp,'Sub-Process' as process,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=sphd_cmy_cd and vcm_vnct_cd=sphd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=sphd_cmy_cd and em_emp_id=sphd_wrk_cd) where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),sphd_wrk_typ,sphd_iss_stk_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd) where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd)  where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Metal' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,-sum(cast(rhd_rcvy as float)) as issuwt,-sum(cast(rhd_rcvy_mtl as float)) as rcvwt,-sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Recovery' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,sum(cast(rhd_rcvy as float)) as issuwt,sum(cast(rhd_rcvy_mtl as float)) as rcvwt,sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,'RRRRR','','','',aphd_expt_prty,'',sum(cast(aphd_prty_ls as float)) as prtyloss,'',sum(cast(aphd_expt_prty as float)*cast(aphd_prty_ls as float)/100) as balpg from aly_prcs_hdr_dtl inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty   order by 1,6 ";
//	var qry="SELECT dm_dpt_nm,'','','Metal' as process,'',ihd_rcvd_prty as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd=\'"+cmycd+"\' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_rcvd_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,crtm_carat_prty union all select dm_dpt_nm as fmdptnm,'','','Metal' as process,'',ithd_itm_prty as commprty,sum(cast(ithd_itm_iss_wgt as float)) as issuwt,'0' as revwt,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd  inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  [ithd_trf_sts]<>'0' and ithd_frm_dpt_cd <> '10006'  group by dm_dpt_nm,ithd_itm_prty union all select dm_dpt_nm as todepnm,'','','Metal' as process,'',ithd_itm_prty as commprty,'0' as issuwt,sum(cast(ithd_itm_iss_wgt as float)) as revwt,'0' as issupg,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1' group by dm_dpt_nm,ithd_itm_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,smd_mtl_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Alloying' as stocktyp,'Alloying' as process,aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)+cast(aphd_iss_aly as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' inner join emp_mst on (em_cmy_cd=aphd_cmy_cd and em_emp_id=aphd_wrk_cd) group by dm_dpt_nm,em_emp_nm,aphd_expt_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Casting' as stocktyp,'Casting' as process ,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') inner join emp_mst on (em_cmy_cd=cphd_cmy_cd and em_emp_id=cphd_wrk_cd)  where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,em_emp_nm,crtm_carat_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,smd_wrk_typ as wrktyp,'Melting' as stocktyp,'Melting' as process,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=smd_cmy_cd and vcm_vnct_cd=smd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=smd_cmy_cd and em_emp_id=smd_wrk_cd) where smd_cmy_cd=\'"+cmycd+"\'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),smd_wrk_typ,smd_mtl_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,sphd_wrk_typ as wrktyp,'Sub-Process' as stocktyp,'Sub-Process' as process,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=sphd_cmy_cd and vcm_vnct_cd=sphd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=sphd_cmy_cd and em_emp_id=sphd_wrk_cd) where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),sphd_wrk_typ,sphd_iss_stk_prty  union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd) where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd)  where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Metal' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,-sum(cast(rhd_rcvy as float)) as issuwt,-sum(cast(rhd_rcvy_mtl as float)) as rcvwt,-sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Recovery' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,sum(cast(rhd_rcvy as float)) as issuwt,sum(cast(rhd_rcvy_mtl as float)) as rcvwt,sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,'PRTYLOSS','','','',aphd_expt_prty,sum(cast(aphd_prty_ls as float)) as prtyloss,'',sum(cast(aphd_expt_prty as float)*cast(aphd_prty_ls as float)/100) as balpg,'' from aly_prcs_hdr_dtl inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty   order by 1,6";
//	var qry="SELECT dm_dpt_nm,'','','Metal' as process,'',ihd_rcvd_prty as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd=\'"+cmycd+"\' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_rcvd_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',aphd_mtl_prty as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,'0' as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,'0' as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_mtl_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',aphd_expt_prty as commprty,'0' as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,'0' as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,crtm_carat_prty union all select dm_dpt_nm as fmdptnm,'','','Metal' as process,'',ithd_itm_prty as commprty,sum(cast(ithd_itm_iss_wgt as float)) as issuwt,'0' as revwt,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd  inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  [ithd_trf_sts]<>'0' and ithd_frm_dpt_cd <> '10006'  group by dm_dpt_nm,ithd_itm_prty union all select dm_dpt_nm as todepnm,'','','Metal' as process,'',ithd_itm_prty as commprty,'0' as issuwt,sum(cast(ithd_itm_iss_wgt as float)) as revwt,'0' as issupg,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1' group by dm_dpt_nm,ithd_itm_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,smd_mtl_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Alloying' as stocktyp,'Alloying' as process,aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)+cast(aphd_iss_aly as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' inner join emp_mst on (em_cmy_cd=aphd_cmy_cd and em_emp_id=aphd_wrk_cd) group by dm_dpt_nm,em_emp_nm,aphd_expt_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Casting' as stocktyp,'Casting' as process ,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') inner join emp_mst on (em_cmy_cd=cphd_cmy_cd and em_emp_id=cphd_wrk_cd)  where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,em_emp_nm,crtm_carat_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,smd_wrk_typ as wrktyp,'Melting' as stocktyp,'Melting' as process,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=smd_cmy_cd and vcm_vnct_cd=smd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=smd_cmy_cd and em_emp_id=smd_wrk_cd) where smd_cmy_cd=\'"+cmycd+"\'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),smd_wrk_typ,smd_mtl_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,sphd_wrk_typ as wrktyp,'Sub-Process' as stocktyp,'Sub-Process' as process,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=sphd_cmy_cd and vcm_vnct_cd=sphd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=sphd_cmy_cd and em_emp_id=sphd_wrk_cd) where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),sphd_wrk_typ,sphd_iss_stk_prty  union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd) where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd)  where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Metal' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,-sum(cast(rhd_rcvy as float)) as issuwt,-sum(cast(rhd_rcvy_mtl as float)) as rcvwt,-sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Recovery' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,sum(cast(rhd_rcvy as float)) as issuwt,sum(cast(rhd_rcvy_mtl as float)) as rcvwt,sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,'PRTYLOSS','','','',aphd_expt_prty,sum(cast(aphd_prty_ls as float)) as prtyloss,'',sum(cast(aphd_expt_prty as float)*cast(aphd_prty_ls as float)/100) as balpg,'' from aly_prcs_hdr_dtl inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty   order by 1,6";
//	var qry="SELECT dm_dpt_nm,'','','Metal' as process,'',ihd_rcvd_prty as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd='10001' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_rcvd_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',aphd_mtl_prty as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,'0' as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,'0' as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' group by dm_dpt_nm,aphd_mtl_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',aphd_expt_prty as commprty,'0' as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,'0' as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' group by dm_dpt_nm,aphd_expt_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd='10001') where cphd_cmy_cd='10001' group by dm_dpt_nm,crtm_carat_prty union all select dm_dpt_nm as fmdptnm,'','','Metal' as process,'',ithd_itm_prty as commprty,sum(cast(ithd_itm_iss_wgt as float)) as issuwt,'0' as revwt,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd  inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd='10001' and  [ithd_trf_sts]<>'0' and ithd_frm_dpt_cd <> '10006'  group by dm_dpt_nm,ithd_itm_prty union all select dm_dpt_nm as todepnm,'','','Metal' as process,'',ithd_itm_prty as commprty,'0' as issuwt,sum(cast(ithd_itm_iss_wgt as float)) as revwt,'0' as issupg,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd='10001' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1' group by dm_dpt_nm,ithd_itm_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd='10001' group by dm_dpt_nm,smd_mtl_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd='10001' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Alloying' as stocktyp,'Alloying' as process,aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)+cast(aphd_iss_aly as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' inner join emp_mst on (em_cmy_cd=aphd_cmy_cd and em_emp_id=aphd_wrk_cd) group by dm_dpt_nm,em_emp_nm,aphd_expt_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Casting' as stocktyp,'Casting' as process ,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd='10001') inner join emp_mst on (em_cmy_cd=cphd_cmy_cd and em_emp_id=cphd_wrk_cd)  where cphd_cmy_cd='10001' group by dm_dpt_nm,em_emp_nm,crtm_carat_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,smd_wrk_typ as wrktyp,'Melting' as stocktyp,'Melting' as process,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=smd_cmy_cd and vcm_vnct_cd=smd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=smd_cmy_cd and em_emp_id=smd_wrk_cd) where smd_cmy_cd='10001'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),smd_wrk_typ,smd_mtl_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,sphd_wrk_typ as wrktyp,'Sub-Process' as stocktyp,'Sub-Process' as process,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=sphd_cmy_cd and vcm_vnct_cd=sphd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=sphd_cmy_cd and em_emp_id=sphd_wrk_cd) where sphd_cmy_cd='10001' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),sphd_wrk_typ,sphd_iss_stk_prty  union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd) where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,case when dhd_trf_typ='Recovery' then (select top 1 cast(rhd_rqd_prty as float) from rcvy_hdr_dtl where rhd_cmy_cd='10001' and dhd_isd_itm_cd=rhd_doc_no) else  dhd_isd_prty end as commprty,(cast('0' as float))as isswt ,case when dhd_trf_typ='Recovery' then round(cast(dhd_rcvd_wgt as float)*cast(dhd_isd_prty as float)/(select top 1 cast(rhd_rqd_prty as float) from rcvy_hdr_dtl where rhd_cmy_cd='10001' and dhd_isd_itm_cd=rhd_doc_no),3) else (cast(dhd_rcvd_wgt as float)) end as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd)  where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess' union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Metal' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,-sum(cast(rhd_rcvy as float)) as issuwt,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/cast(rhd_rqd_prty as float),3)) as rcvwt,-sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd='10001'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Recovery' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,sum(cast(rhd_rcvy as float)) as issuwt,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/cast(rhd_rqd_prty as float),3)) as rcvwt,sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd='10001'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,'PRTYLOSS','','','',aphd_expt_prty,sum(cast(aphd_prty_ls as float)) as prtyloss,'',sum(cast(aphd_expt_prty as float)*cast(aphd_prty_ls as float)/100) as balpg,'' from aly_prcs_hdr_dtl inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' group by dm_dpt_nm,aphd_expt_prty   order by 1,6";
	var qry="SELECT dm_dpt_nm,'','','Metal' as process,'',ihd_rcvd_prty as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd=\'"+cmycd+"\' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_rcvd_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',aphd_mtl_prty as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,'0' as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,'0' as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_mtl_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',aphd_expt_prty as commprty,'0' as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,'0' as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,crtm_carat_prty union all select dm_dpt_nm as fmdptnm,'','','Metal' as process,'',ithd_itm_prty as commprty,case when ithd_itm_trn_typ<>'Bom' then sum(cast(ithd_itm_iss_wgt as float)) else (select top 1 ith_tot_iss_wgt from intl_trf_hdr where ith_doc_no=ithd_doc_no) end as issuwt,'0' as revwt,case when ithd_itm_trn_typ<>'Bom' then round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3)else round(((select top 1 cast(ith_tot_iss_wgt as float) from intl_trf_hdr where ith_doc_no=ithd_doc_no)*(cast(case when ithd_itm_prty<>'' then ithd_itm_prty else '0' end as decimal(5,2))))/100,3) end as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd  inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  [ithd_trf_sts]<>'0' and ithd_frm_dpt_cd <> '10006'   group by ithd_doc_no,ithd_itm_trn_typ,dm_dpt_nm,ithd_itm_prty union all select dm_dpt_nm as todepnm,'','','Metal' as process,'',ithd_itm_prty as commprty,'0' as issuwt,case when ithd_itm_trn_typ<>'Bom' then sum(cast(ithd_itm_iss_wgt as float)) else (select top 1 ith_tot_iss_wgt from intl_trf_hdr where ith_doc_no=ithd_doc_no) end as revwt,'0' as issupg,case when ithd_itm_trn_typ<>'Bom' then round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3)else round(((select top 1 cast(ith_tot_iss_wgt as float) from intl_trf_hdr where ith_doc_no=ithd_doc_no)*(cast(case when ithd_itm_prty<>'' then ithd_itm_prty else '0' end as decimal(5,2))))/100,3) end as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd=\'"+cmycd+"\' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1'  group by ithd_doc_no,ithd_itm_trn_typ,dm_dpt_nm,ithd_itm_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,smd_mtl_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Alloying' as stocktyp,'Alloying' as process,aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)+cast(aphd_iss_aly as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' inner join emp_mst on (em_cmy_cd=aphd_cmy_cd and em_emp_id=aphd_wrk_cd) group by dm_dpt_nm,em_emp_nm,aphd_expt_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Casting' as stocktyp,'Casting' as process ,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') inner join emp_mst on (em_cmy_cd=cphd_cmy_cd and em_emp_id=cphd_wrk_cd)  where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,em_emp_nm,crtm_carat_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,smd_wrk_typ as wrktyp,'Melting' as stocktyp,'Melting' as process,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=smd_cmy_cd and vcm_vnct_cd=smd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=smd_cmy_cd and em_emp_id=smd_wrk_cd) where smd_cmy_cd=\'"+cmycd+"\'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),smd_wrk_typ,smd_mtl_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,sphd_wrk_typ as wrktyp,'Sub-Process' as stocktyp,'Sub-Process' as process,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=sphd_cmy_cd and vcm_vnct_cd=sphd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=sphd_cmy_cd and em_emp_id=sphd_wrk_cd) where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),sphd_wrk_typ,sphd_iss_stk_prty  union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd) where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,case when dhd_trf_typ='Recovery' then (select top 1 cast(rhd_rqd_prty as float) from rcvy_hdr_dtl where rhd_cmy_cd=\'"+cmycd+"\' and dhd_isd_itm_cd=rhd_doc_no) else  dhd_isd_prty end as commprty,(cast('0' as float))as isswt ,case when dhd_trf_typ='Recovery' then round(cast(dhd_rcvd_wgt as float)*cast(dhd_isd_prty as float)/(select top 1 cast(rhd_rqd_prty as float) from rcvy_hdr_dtl where rhd_cmy_cd=\'"+cmycd+"\' and dhd_isd_itm_cd=rhd_doc_no),3) else (cast(dhd_rcvd_wgt as float)) end as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd)  where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Metal' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,-sum(cast(rhd_rcvy as float)) as issuwt,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/cast(rhd_rqd_prty as float),3)) as rcvwt,-sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Recovery' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,sum(cast(rhd_rcvy as float)) as issuwt,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/cast(rhd_rqd_prty as float),3)) as rcvwt,sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd=\'"+cmycd+"\'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,'PRTYLOSS','','','',aphd_expt_prty,sum(cast(aphd_prty_ls as float)) as prtyloss,'',sum(cast(aphd_expt_prty as float)*cast(aphd_prty_ls as float)/100) as balpg,'' from aly_prcs_hdr_dtl inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_expt_prty   order by 1,6";
	AjaxController.getClosingStockReports(qry,closingRecords);
}
function closingRecords(result){
	var res="";
	var count=0;
	if(result!=null && result.length>0){
		var dept='',purity='';
		var balwt=0,balpg=0,totbalwt=0,totbalpg=0;
		if(result.length>1){
			for (var i = 0; i < result.length; i++) {
				if(i==0){
					dept=result[i][0];
					emp=result[i][1];
					purity=result[i][5];
					if(result[i][1]=='') {
						balwt+=(Number(result[i][7])-Number(isuwt=result[i][6]));
						balpg+=(Number(result[i][9])-Number(isuwt=result[i][8]));
					}
					else{
						balwt+=(Number(result[i][6])-Number(isuwt=result[i][7]));
						balpg+=(Number(result[i][8])-Number(isuwt=result[i][9]));
					}
					if(typeof(result[i+1]) != "undefined" && dept==result[i+1][0],purity==result[i+1][5]){}
					else{
						if(Number(balwt).toFixed(2)!=0.00 ||  Number(balpg).toFixed(2)!=0.00){
						res+='<tr>'
							+'<td class=""><label class="control-label lbl" >'+(++count)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][0]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][5]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(balwt).toFixed(3)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(balpg).toFixed(3)+'</label></td>'
							+'</tr>';
						}
						totbalwt+=Number(balwt);
						totbalpg+=Number(balpg);
						balwt=0,balpg=0;
						if(typeof(result[i+1]) != "undefined")dept=result[i+1][0];
						if(typeof(result[i+1]) != "undefined")purity=result[i+1][5];
					}
				}else{
					if(typeof(result[i+1]) != "undefined" &&  dept==result[i+1][0] && purity==result[i+1][5]){
						if(result[i][1]=='') {
							balwt+=(Number(result[i][7])-Number(isuwt=result[i][6]));
							balpg+=(Number(result[i][9])-Number(isuwt=result[i][8]));
						}
						else{
							balwt+=(Number(result[i][6])-Number(isuwt=result[i][7]));
							balpg+=(Number(result[i][8])-Number(isuwt=result[i][9]));
						}
						
					}else{
						if(result[i][1]=='') {
							balwt+=(Number(result[i][7])-Number(isuwt=result[i][6]));
							balpg+=(Number(result[i][9])-Number(isuwt=result[i][8]));
						}
						else{
							balwt+=(Number(result[i][6])-Number(isuwt=result[i][7]));
							balpg+=(Number(result[i][8])-Number(isuwt=result[i][9]));
						}
						if(Number(balwt).toFixed(2)!=0.00 ||  Number(balpg).toFixed(2)!=0.00){
						res+='<tr>'
							+'<td class=""><label class="control-label lbl" >'+(++count)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][0]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+result[i][5]+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(balwt).toFixed(3)+'</label></td>'
							+'<td class=""><label class="control-label lbl" >'+Number(balpg).toFixed(3)+'</label></td>'
							+'</tr>';
						}
						totbalwt+=Number(balwt);
						totbalpg+=Number(balpg);
						balwt=0,balpg=0;
						if(typeof(result[i+1]) != "undefined" )dept=result[i+1][0];
						if(typeof(result[i+1]) != "undefined" )purity=result[i+1][5];
					}
					
				}
				
			}
		
		}else{
			if(result[0][1]=='') {
				balwt+=(Number(result[0][7])-Number(isuwt=result[0][6]));
				balpg+=(Number(result[0][9])-Number(isuwt=result[0][8]));
			}
			else{
				balwt+=(Number(result[0][6])-Number(isuwt=result[0][7]));
				balpg+=(Number(result[0][8])-Number(isuwt=result[0][9]));
			}
			res+='<tr>'
				+'<td class=""><label class="control-label lbl" >1</label></td>'
				+'<td class=""><label class="control-label lbl" >'+result[0][0]+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(result[0][5]).toFixed(3)+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(balwt).toFixed(3)+'</label></td>'
				+'<td class=""><label class="control-label lbl" >'+Number(balpg).toFixed(3)+'</label></td>'
				+'</tr>';
			totbalwt+=Number(balwt);
			totbalpg+=Number(balpg);
			balwt=0;balpg=0;
		}
		res+='<tr>'
			+'<td class=""><label class="control-label lbl" >Total</label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" ></label></td>'
			+'<td class=""><label class="control-label lbl" >'+Number(totbalwt).toFixed(3)+'</label></td>'
			+'<td class=""><label class="control-label lbl" >'+Number(totbalpg).toFixed(3)+'</label></td>'
			+'</tr>';
		balwt=0;balpg=0;
	}
	document.getElementById("closingstockrecords").innerHTML=res;
}


function searchInReports(){
	var cmycd=document.getElementById("cmycd").value;
	var dept=document.getElementById("dept").value;
	var prty=document.getElementById("prty").value;
	var wrkr=document.getElementById("wrkr").value;
	AjaxController.searchInInwordrecordgloballist(cmycd,dept,prty,inwardRecords);
	AjaxController.searchInPurityLoss(cmycd,dept,prty,purityLossRecords);
	AjaxController.searchinworker(cmycd,"ComWrker",dept,prty,wrkr,workerrecords);
	AjaxController.searchinworker(cmycd,"OutSideWrker",dept,prty,wrkr,outsideworkerrecords);
	AjaxController.searchinclosingstock(cmycd,dept,prty,closingRecords);
	
}
function ExportRecords(val){
	var qry="";
	var cmycd=document.getElementById("cmycd").value;
	if(val=='Locker'){
		qry="SELECT dm_dpt_nm,ihd_iwd_typ,ihd_rcvd_prty as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd=\'"+cmycd+"\' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_iwd_typ,ihd_rcvd_prty union all SELECT dm_dpt_nm,aphd_aly_typ,aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,aphd_aly_typ,aphd_expt_prty  union all  SELECT dm_dpt_nm,cphd_cst_typ,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd=\'"+cmycd+"\') where cphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,cphd_cst_typ,crtm_carat_prty   union all select dm_dpt_nm as fmdptnm,ithd_itm_trn_typ,ithd_itm_prty as commprty,sum(cast(ithd_itm_iss_wgt as float)) as issuwt,'0' as revwt,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd where ithd_cmy_cd=\'"+cmycd+"\' and  [ithd_trf_sts]<>'0' group by dm_dpt_nm,ithd_itm_trn_typ,ithd_itm_prty union all select dm_dpt_nm as todepnm,ithd_itm_trn_typ,ithd_itm_prty as commprty,'0' as issuwt,sum(cast(ithd_itm_iss_wgt as float)) as revwt,'0' as issupg,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd where ithd_cmy_cd=\'"+cmycd+"\' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1' group by dm_dpt_nm,ithd_itm_trn_typ,ithd_itm_prty union all select dm_dpt_nm,smd_trf_typ,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,smd_trf_typ,smd_mtl_prty union all select dm_dpt_nm,'JOB WORK-DMainReceived' as typ,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd=\'"+cmycd+"\' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,dhd_trf_typ,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_trf_typ,dhd_isd_prty union all SELECT dm_dpt_nm,dhd_trf_typ,dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd=\'"+cmycd+"\' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_trf_typ,dhd_isd_prty order by 1,2,3";
		window.location.href="exportLocakerStock.mm?query="+qry;
	}
}









/*


[btw_aly_typ],[btw_bom_wgt],[btw_cmy_cd],[btw_cnvt_prty],[btw_dept],[btw_doc_dt],[btw_doc_no],[btw_emp_cd],[btw_expt_prty],[btw_expt_wt]
,[btw_fnsh_pdt],[btw_iss_aly],[btw_iss_pg],[btw_iss_prty],[btw_iss_wgt],[btw_itm_cd],[btw_itm_typ],[btw_pdt_wgt],[btw_prcs_typ],[btw_prty_los]
,[btw_pwdr_mtl],[btw_rcv_pg],[btw_rcv_prty],[btw_rcv_wgt],[btw_rcvy_wgt],[btw_rmve_rcvy_wgt],[btw_rnr_wgt],[btw_scrn],[btw_scrp_mtl],[btw_semi_pdt]
,[btw_smpl_no],[btw_smpl_wgt],[btw_str_cd],[btw_tree_no],[btw_tree_wgt],[btw_trf_typ],[btw_wrkr_cd]


ihd_pdt_qty:1,ihd_doc_no:10000,ihd_cmy_cd:10001,ihd_str_cd:10000,ihd_iwd_typ:Raw Metrial,ihd_vndr_cd:11110006,ihd_vndr_inc_no:123456,ihd_vndr_inc_dt:19-Jun-18 12:19,ihd_dpt_cd:10003,ihd_pdt_cd:10000,ihd_mtl_wgt:13434.36,ihd_rcvd_prty:91.70,ihd_doc_val:0,ihd_pgm_cal:39015248.816,ihd_pure_gld_wgt:12319.308,ihd_iwd_sts:true,ihd_pdt_nm:RAW GOLD,ihd_iss_auth:true




[ update stk_mst set stm_rcvd_stk_wgt=(cast(stm_rcvd_stk_wgt as float)+cast(13434.36 as float)),stm_stk_pure_gld_wgt=(cast(stm_stk_pure_gld_wgt as float)+cast(12319.308 as float)),stm_stk_pure_doc_val=(cast(stm_stk_pure_doc_val as float)+cast(0 as float)),stm_stk_pure_pgm_cal=(cast(stm_stk_pure_pgm_cal as float)+cast(39015248.816 as float)) where stm_itm_cd='10000' and stm_rcvd_stk_prty='91.70' and stm_stk_itm_typ='Raw Metrial' and stm_stk_trn_typ='Inward'   and stm_dpt_cd='10003' and stm_cmy_cd='10001' IF @@ROWCOUNT=0 insert into stk_mst ([stm_cmy_cd] ,[stm_dpt_cd] ,[stm_itm_cd] ,[stm_rcvd_stk_wgt] ,[stm_stk_crt_dt] ,[stm_stk_crt_id] ,[stm_stk_trn_typ],[stm_stk_updt_dt],[stm_stk_updt_id],stm_rcvd_stk_prty,stm_stk_itm_typ,stm_str_cd,stm_stk_pure_gld_wgt,stm_stk_pure_doc_val,stm_stk_pure_pgm_cal) values ('10001','10003','10000','13434.36','19-Jun-18','10000','Inward','19-Jun-18','10000','91.70','Raw Metrial','10000','12319.308','0','39015248.816'),update stone_stk set ss_stn_qty=(isnull(ss_stn_qty,0)+cast'1' as float)) where ss_stn_cd='10000' and ss_stn_prty='91.70' and ss_dpt_cd='10003' and ss_cmy_cd='10001' if @@ROWCOUNT=0 INSERT INTO [stone_stk] ([ss_stn_cd] ,[ss_stn_prty] ,[ss_stn_qty] ,[ss_stn_wgt] ,[ss_cmy_cd] ,[ss_crt_dt] ,[ss_dpt_cd] ,[ss_updt_dt]) VALUES ('10000','91.70','1','0','10001','19-Jun-18','10003','19-Jun-18')]

*/



//SELECT dm_dpt_nm,'','','Metal' as process,'',ihd_rcvd_prty as commprty,'0' as issuwt,sum(cast(ihd_mtl_wgt as float)) as revwt,'0' as issupg,round(((sum(cast(ihd_mtl_wgt as float))*cast(ihd_rcvd_prty as float))/100),3) as revpg FROM [iwd_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ihd_cmy_cd and ihd_dpt_cd=dm_dpt_cd where ihd_cmy_cd='10001' and [ihd_iwd_sts]='1' group by dm_dpt_nm,ihd_rcvd_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',aphd_mtl_prty as commprty,sum(cast(aphd_iss_wgt as float)) as issuwt,'0' as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,'0' as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' group by dm_dpt_nm,aphd_mtl_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',aphd_expt_prty as commprty,'0' as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,'0' as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' group by dm_dpt_nm,aphd_expt_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd='10001') where cphd_cmy_cd='10001' group by dm_dpt_nm,crtm_carat_prty union all select dm_dpt_nm as fmdptnm,'','','Metal' as process,'',ithd_itm_prty as commprty,sum(cast(ithd_itm_iss_wgt as float)) as issuwt,'0' as revwt,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as issupg,'0' as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_frm_dpt_cd=dm_dpt_cd  inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd='10001' and  [ithd_trf_sts]<>'0' and ithd_frm_dpt_cd <> '10006'  group by dm_dpt_nm,ithd_itm_prty union all select dm_dpt_nm as todepnm,'','','Metal' as process,'',ithd_itm_prty as commprty,'0' as issuwt,sum(cast(ithd_itm_iss_wgt as float)) as revwt,'0' as issupg,round((sum(cast(ithd_itm_iss_wgt as float)*cast(ithd_itm_prty as float)))/100,3) as rcvpg from [intl_trf_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=ithd_cmy_cd and ithd_to_dpt_cd=dm_dpt_cd inner join [intl_trf_hdr] on [ithd_doc_no]=[ith_doc_no] and [ithd_cmy_cd]=[ith_cmy_cd] and [ith_trf_sts]<>0 where ithd_cmy_cd='10001' and  ithd_trf_sts<>'0' and  dm_is_fns <>'1' group by dm_dpt_nm,ithd_itm_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd where smd_cmy_cd='10001' group by dm_dpt_nm,smd_mtl_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd where sphd_cmy_cd='10001' group by dm_dpt_nm,sphd_iss_stk_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,'','','Metal' as process,'',dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd   where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,dhd_isd_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Alloying' as stocktyp,'Alloying' as process,aphd_expt_prty as commprty,sum(cast(aphd_iss_wgt as float)+cast(aphd_iss_aly as float)) as issuwt,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))),3)) as rcvwt,sum(round((cast(aphd_iss_wgt as float)*cast(aphd_mtl_prty as float))/100,3)) as issupg,sum(round(((cast(aphd_rcvd_wgt as float)+cast(aphd_tot_tst_smp as float)+cast(aphd_dst_mtl as float))*cast(aphd_cvt_prty as float))/100,3)) as revpg FROM [aly_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' inner join emp_mst on (em_cmy_cd=aphd_cmy_cd and em_emp_id=aphd_wrk_cd) group by dm_dpt_nm,em_emp_nm,aphd_expt_prty union all SELECT dm_dpt_nm,em_emp_nm,'ComWrker' as wrktyp,'Casting' as stocktyp,'Casting' as process ,crtm_carat_prty as commprty,sum(cast(cphd_iss_wgt as float)) as issuwt,sum(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)) as revwt,round(sum((cast(crtm_carat_prty as float)*cast(cphd_iss_wgt as float))/100),3) as issupg,round(sum((cast(crtm_carat_prty as float)*(cast(cphd_pdt_wgt as float)+cast(cphd_run_wgt as float)+cast(cphd_tst_smp as float)+cast(cphd_pwd_mtl as float)))/100),3) as rcvpg FROM [cst_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=cphd_cmy_cd and cphd_dpt_cd=dm_dpt_cd  inner join [carat_mst] on (cphd_iss_carat=crtm_carat_nm and crtm_cmy_cd='10001') inner join emp_mst on (em_cmy_cd=cphd_cmy_cd and em_emp_id=cphd_wrk_cd)  where cphd_cmy_cd='10001' group by dm_dpt_nm,em_emp_nm,crtm_carat_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,smd_wrk_typ as wrktyp,'Melting' as stocktyp,'Melting' as process,smd_mtl_prty as commprty,sum(cast(smd_isd_mtl_wgt as float)) as issuwt,sum((cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float))) as rcvwt ,round(sum((cast(smd_mtl_prty as float)*cast(smd_isd_mtl_wgt as float))/100),3) as issupg,round(sum((cast(smd_mtl_prty as float)*(cast(smd_rcvd_mtl_wgt as float)+cast(smd_test_smp_wgt as float)+cast(smd_dust_mtl as float)))/100),3) as rcvpg from [sub_melt_dtl] inner join dpt_mst  on dm_cmy_cd=smd_cmy_cd and smd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=smd_cmy_cd and vcm_vnct_cd=smd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=smd_cmy_cd and em_emp_id=smd_wrk_cd) where smd_cmy_cd='10001'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),smd_wrk_typ,smd_mtl_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,sphd_wrk_typ as wrktyp,'Sub-Process' as stocktyp,'Sub-Process' as process,sphd_iss_stk_prty as commprty,sum(cast(sphd_iss_stk_wgt as float)) as issuwt,sum(cast(sphd_rcvd_stk_wgt as float)) as rcvwt,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_iss_stk_wgt as float))/100),3) as issupg,round(sum((cast(sphd_iss_stk_prty as float)*cast(sphd_rcvd_stk_wgt as float))/100),3) as rcvpg from  [sub_prcs_hdr_dtl] inner join dpt_mst  on dm_cmy_cd=sphd_cmy_cd and sphd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=sphd_cmy_cd and vcm_vnct_cd=sphd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=sphd_cmy_cd and em_emp_id=sphd_wrk_cd) where sphd_cmy_cd='10001' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),sphd_wrk_typ,sphd_iss_stk_prty  union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast(dhd_isd_wgt as float)) as isswt,sum(cast('0' as float)) as recwt ,round((cast(dhd_isd_prty as float)*sum(cast(dhd_isd_wgt as float)))/100,3) as issupg,round(cast(dhd_isd_prty as float)*sum(cast('0' as float)),3) as rcvpg FROM [dc_hdr_dtl] a  inner join dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no and dhd_cmy_cd=dh_cmy_cd inner join dpt_mst on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd) where dh_trf_typ in ('ForIssue','ForSamplesIssue') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess' group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all SELECT dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,dhd_wrk_typ,'Metal' as stocktyp,'JobWork' as process,dhd_isd_prty as commprty,sum(cast('0' as float))as isswt ,sum(cast(dhd_rcvd_wgt as float)) as recwt,'0' as isspg,round((cast(dhd_isd_prty as float)*sum(cast(dhd_rcvd_wgt as float)))/100,3) as rcvpg FROM [dc_hdr_dtl] a inner join  dc_hdr c on c.dh_isd_doc_no=a.dhd_isd_doc_no   and dhd_cmy_cd=dh_cmy_cd left join dpt_mst b on dm_cmy_cd=dhd_cmy_cd and dhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=dhd_cmy_cd and vcm_vnct_cd=dhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=dhd_cmy_cd and em_emp_id=dhd_wrk_cd)  where dh_trf_typ in ('ForSamplesReturn','ForReturn') and dhd_cmy_cd='10001' and  dhd_trf_typ <> 'MeltingProcess'  group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),dhd_wrk_typ,dhd_isd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Metal' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,-sum(cast(rhd_rcvy as float)) as issuwt,-sum(cast(rhd_rcvy_mtl as float)) as rcvwt,-sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,-sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd='10001'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm) as empnm,rhd_wrk_typ,'Recovery' as stocktyp,'recory' as process,rhd_rqd_prty as commprty,sum(cast(rhd_rcvy as float)) as issuwt,sum(cast(rhd_rcvy_mtl as float)) as rcvwt,sum(round((cast(rhd_rqd_prty as float)*cast(rhd_rcvy as float))/100,3)) as issupg,sum(round((cast(rhd_mtl_prty as float)*cast(rhd_rcvy_mtl as float))/100,3)) as rcvpg from rcvy_hdr_dtl inner join dpt_mst on dm_cmy_cd=rhd_cmy_cd and rhd_dpt_cd=dm_dpt_cd left join [vn_ct_mst] on (vcm_cmy_cd=rhd_cmy_cd and vcm_vnct_cd=rhd_wrk_cd) left join emp_mst on (em_emp_typ='Worker' and em_cmy_cd=[rhd_cmy_cd] and em_emp_id=rhd_wrk_cd)  where rhd_cmy_cd='10001'   group by dm_dpt_nm,isnull(vcm_vnct_nm,em_emp_nm),rhd_wrk_typ,rhd_rqd_prty union all select dm_dpt_nm,'PRTYLOSS','','','',aphd_expt_prty,sum(cast(aphd_prty_ls as float)) as prtyloss,'',sum(cast(aphd_expt_prty as float)*cast(aphd_prty_ls as float)/100) as balpg,'' from aly_prcs_hdr_dtl inner join dpt_mst  on dm_cmy_cd=aphd_cmy_cd and aphd_dpt_cd=dm_dpt_cd and  aphd_cmy_cd='10001' group by dm_dpt_nm,aphd_expt_prty   order by 1,6